<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>üíñ Our Love Garden üíê</title>
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Love Garden">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* --- CORE ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        
        @keyframes pop { 0% { transform: scale(0.8); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .animate-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* --- THEME STYLES --- */
        :root {
            --bg-gradient-from: #e0f2fe; /* sky-100 */
            --bg-gradient-to: #f0f9ff; /* sky-50 */
            --accent-color: #ec4899;
        }
        body { transition: background-color 1s ease, color 0.5s ease; overflow: hidden; }
        
        /* Day Theme */
        body.theme-day { background: linear-gradient(to bottom, #7dd3fc, #bae6fd); color: #1e293b; }
        /* Night Theme */
        body.theme-night { background: linear-gradient(to bottom, #0f172a, #312e81); color: #e2e8f0; }
        /* Sunset Theme */
        body.theme-sunset { background: linear-gradient(to bottom, #f43f5e, #fbbf24); color: #fff1f2; }

        /* --- DYNAMIC BACKGROUND ELEMENTS --- */
        .cloud {
            position: absolute; background: rgba(255,255,255,0.6); border-radius: 50%;
            animation: floatCloud linear infinite; pointer-events: none; z-index: 0;
        }
        .cloud::after { content: ''; position: absolute; background: inherit; border-radius: 50%; }
        @keyframes floatCloud { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }

        .star {
            position: absolute; background: white; border-radius: 50%;
            animation: twinkle ease-in-out infinite; pointer-events: none; z-index: 0;
        }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        /* --- ORGANIC GARDEN --- */
        #garden-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; z-index: 0; /* Behind UI */
        }
        /* The grass floor */
        .ground-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40%;
            background: linear-gradient(to top, rgba(20, 83, 45, 0.5), transparent);
            pointer-events: none; z-index: 0;
        }
        .flower-sprite {
            position: absolute; bottom: 0; 
            transition: all 0.5s ease;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1));
            font-size: 2rem;
            transform-origin: bottom center;
            animation: growFlower 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            z-index: 10;
        }
        @keyframes growFlower { from { transform: scale(0); } to { transform: scale(1); } }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        body.theme-night .glass-panel { background: rgba(15, 23, 42, 0.4); border-color: rgba(255,255,255,0.1); }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            display: flex; justify-content: space-around;
            padding: 10px; border-radius: 24px;
            z-index: 50;
        }
        .nav-btn {
            font-size: 1.5rem; opacity: 0.6; transition: all 0.2s;
            position: relative;
        }
        .nav-btn.active { opacity: 1; transform: translateY(-5px); }
        .nav-btn.active::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: currentColor; border-radius: 50%;
        }

        /* Juicy Buttons */
        .juicy-btn {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .juicy-btn:active { transform: scale(0.90); }

        /* Polaroid Memory */
        .polaroid {
            background: white; padding: 10px 10px 25px 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: rotate(-2deg); margin-bottom: 15px;
            color: #333; font-family: 'Courier New', monospace;
            animation: fadeIn 0.5s ease-out;
        }
        .polaroid:nth-child(even) { transform: rotate(1deg); }

        /* Gift Box Overlay */
        #gift-overlay {
            position: fixed; inset: 0; z-index: 100;
            background: rgba(0,0,0,0.8);
        }
        .gift-box { font-size: 5rem; cursor: pointer; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* Heartbeat */
        #heartbeat-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 60; opacity: 0;
            background: radial-gradient(circle, rgba(244, 114, 182, 0.6) 0%, transparent 70%);
            transition: opacity 0.2s;
        }
        .pulse-active { animation: heartbeat-flash 1s ease-in-out 2; }
        @keyframes heartbeat-flash { 0% { opacity: 0; transform: scale(0.9); } 30% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(0.9); } }
        
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 70; }
    </style>
</head>
<body class="theme-day font-sans text-gray-800">

    <!-- Background Layers -->
    <div id="bg-layer" class="absolute inset-0 overflow-hidden pointer-events-none">
        <!-- Clouds/Stars injected here -->
    </div>
    
    <!-- Heartbeat & Confetti Layers -->
    <div id="heartbeat-overlay"></div>
    <canvas id="confetti-canvas"></canvas>

    <!-- Gift Overlay (Hidden by default) -->
    <div id="gift-overlay" class="hidden flex flex-col items-center justify-center cursor-pointer" onclick="openGift()">
        <div class="gift-box">üéÅ</div>
        <p class="text-white mt-4 font-bold animate-pulse">You have new flowers! (Tap to open)</p>
    </div>

    <!-- MAIN APP CONTAINER -->
    <div id="app-container" class="relative z-10 flex flex-col h-full min-h-screen">
        
        <!-- Header -->
        <div class="flex justify-between items-center p-4 pt-8 glass-panel rounded-b-3xl mx-2 mt-2 z-50">
            <div>
                <h1 class="text-2xl font-extrabold tracking-tight">Love Garden</h1>
                <div class="flex items-center gap-2 text-xs opacity-70">
                    <span id="petals-count" class="font-bold">0</span> ü™ô Petals
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Theme Selector (Replaced Ambience) -->
                <select id="theme-selector" onchange="changeTheme(this.value)" class="bg-white/20 border border-white/30 rounded-lg p-1 text-xs focus:outline-none backdrop-blur-sm">
                    <option value="theme-day">‚òÄÔ∏è Day</option>
                    <option value="theme-night">üåô Night</option>
                    <option value="theme-sunset">üåÖ Sunset</option>
                </select>
                <!-- Removed Disconnect/Logout Button -->
            </div>
        </div>

        <!-- AUTH SCREEN -->
        <div id="view-auth" class="hidden flex-grow flex flex-col items-center justify-center p-6 z-50 relative">
            <div class="glass-panel p-8 rounded-3xl w-full max-w-sm text-center">
                <h2 id="auth-title" class="text-2xl font-bold mb-6 text-pink-500">Welcome</h2>
                <input type="email" id="auth-email" placeholder="Email" class="w-full p-4 mb-3 rounded-2xl bg-white/50 border-none focus:ring-2 focus:ring-pink-400 outline-none text-gray-800">
                <input type="password" id="auth-password" placeholder="Password" class="w-full p-4 mb-6 rounded-2xl bg-white/50 border-none focus:ring-2 focus:ring-pink-400 outline-none text-gray-800">
                <button onclick="handleAuthAction()" class="w-full py-4 bg-pink-500 text-white rounded-2xl font-bold shadow-lg juicy-btn mb-4">Log In</button>
                <p class="text-sm opacity-60">
                    <button onclick="toggleAuthMode()" id="auth-toggle-btn" class="underline">Create Account</button>
                </p>
                <div id="auth-error" class="hidden mt-4 text-xs text-red-500 bg-red-100 p-2 rounded-lg"></div>
            </div>
        </div>

        <!-- CONNECTION SCREEN -->
        <div id="view-connection" class="hidden flex-grow flex flex-col items-center justify-center p-6 z-50 relative">
            <div class="glass-panel p-8 rounded-3xl w-full max-w-sm text-center">
                <h2 class="text-xl font-bold mb-2">Connect Partners</h2>
                <div class="bg-white/40 p-3 rounded-xl mb-4 text-xs font-mono break-all select-all" id="my-id">...</div>
                <button onclick="copyMyId()" class="text-xs bg-white/50 px-3 py-1 rounded-full mb-6">Copy My ID</button>
                
                <input type="text" id="partner-id-input" placeholder="Paste Partner ID" class="w-full p-4 mb-4 rounded-2xl bg-white/50 border-none outline-none text-center">
                <button onclick="connectToPartner()" class="w-full py-4 bg-green-500 text-white rounded-2xl font-bold shadow-lg juicy-btn">Connect</button>
            </div>
        </div>

        <!-- MAIN GAME VIEW -->
        <div id="view-game" class="hidden flex-grow relative">
            
            <!-- GARDEN TAB (Organic Layout) -->
            <div id="tab-garden-content" class="absolute inset-0">
                <!-- Sky decorations (purchased) -->
                <div id="sky-layer" class="absolute top-20 w-full flex justify-center gap-4 z-0 pointer-events-none opacity-80"></div>
                
                <!-- The actual organic garden -->
                <div id="garden-container">
                    <div class="ground-overlay"></div>
                    <!-- Flowers injected here via JS -->
                </div>

                <!-- Controls Container (Floating above bottom nav) -->
                <div class="absolute bottom-24 w-full px-4 flex flex-col gap-2 z-20">
                    <!-- Status Bubble -->
                    <div id="status-display" class="bg-white/70 backdrop-blur-sm rounded-2xl p-2 text-center text-xs shadow-sm min-h-[2.5rem] flex flex-col justify-center mx-4">
                        Welcome to the garden!
                    </div>
                    
                    <!-- Input & Actions -->
                    <div class="flex gap-2">
                        <input type="text" id="love-note" placeholder="Write a note..." class="flex-grow p-3 rounded-2xl bg-white/80 border-none shadow-sm focus:ring-2 focus:ring-pink-300 outline-none text-sm">
                        <button onclick="sendHeartbeat()" class="w-12 bg-red-100 text-red-500 rounded-2xl shadow-md juicy-btn flex items-center justify-center text-lg">‚ù§Ô∏è</button>
                    </div>
                    <button onclick="sendFlower()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl font-bold shadow-lg juicy-btn text-sm">
                        Plant Flower üå∏
                    </button>
                </div>
            </div>

            <!-- MEMORY TAB -->
            <div id="tab-memory-content" class="hidden absolute inset-0 p-4 overflow-y-auto pb-32 pt-24 z-20">
                <h3 class="text-center font-bold opacity-50 mb-4 uppercase tracking-widest text-xs">Memory Wall</h3>
                <div id="memory-wall" class="flex flex-col items-center">
                    <!-- Polaroids injected here -->
                </div>
            </div>

            <!-- SHOP TAB -->
            <div id="tab-shop-content" class="hidden absolute inset-0 p-4 overflow-y-auto pb-32 pt-24 z-20">
                <h3 class="text-center font-bold opacity-50 mb-4 uppercase tracking-widest text-xs">Garden Shop</h3>
                <div id="shop-grid" class="grid grid-cols-2 gap-4"></div>
            </div>

            <!-- DAILY TAB -->
            <div id="tab-daily-content" class="hidden absolute inset-0 p-6 flex flex-col items-center justify-center z-20">
                <div class="glass-panel p-6 rounded-3xl w-full text-center">
                    <div class="inline-block bg-pink-100 text-pink-600 px-3 py-1 rounded-full text-xs font-bold mb-4">Daily Question</div>
                    <h3 id="daily-question-text" class="text-lg font-bold mb-6">Loading...</h3>
                    
                    <div id="daily-input-area">
                        <textarea id="daily-answer-input" rows="3" placeholder="Answer here..." class="w-full p-3 rounded-xl bg-white/50 mb-4 outline-none"></textarea>
                        <button onclick="submitDailyAnswer()" class="w-full py-3 bg-pink-500 text-white rounded-xl font-bold juicy-btn">Submit</button>
                    </div>
                    
                    <div id="daily-result-area" class="hidden">
                        <div id="daily-status-msg" class="text-sm font-bold text-green-600 mb-4"></div>
                        <div id="partner-answer-display" class="hidden bg-yellow-50/80 p-4 rounded-xl text-left">
                            <p class="text-xs opacity-50 uppercase font-bold mb-1">Partner said:</p>
                            <p id="partner-answer-text" class="italic">...</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- BOTTOM NAVIGATION -->
        <div id="bottom-nav" class="bottom-nav glass-panel hidden">
            <button onclick="switchTab('garden')" id="nav-garden" class="nav-btn active text-pink-500">üå∫</button>
            <button onclick="switchTab('memory')" id="nav-memory" class="nav-btn text-gray-500">üì∏</button>
            <button onclick="switchTab('shop')" id="nav-shop" class="nav-btn text-gray-500">üõí</button>
            <button onclick="switchTab('daily')" id="nav-daily" class="nav-btn text-gray-500">üìÖ</button>
        </div>

        <!-- VIEW 0: Loading Screen (Visible by Default) -->
        <div id="view-loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center animate-fade-in">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-pink-200 border-t-pink-500 mb-4"></div>
            <h2 class="text-xl font-bold text-gray-700">Initializing Love Garden...</h2>
            <p class="text-xs text-gray-500 mt-2">Connecting to cloud...</p>
        </div>

    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURATION
        const manualConfig = {
            apiKey: "AIzaSyBEA9tEwiCr__ohGhTqEZ7dbfmjgRMh1D8",
            authDomain: "flower-exchange-423b6.firebaseapp.com",
            projectId: "flower-exchange-423b6",
            storageBucket: "flower-exchange-423b6.firebasestorage.app",
            messagingSenderId: "312133979500",
            appId: "1:312133979500:web:0f70ff976e7b9a1c59b749"
        };

        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : manualConfig;
        const collectionPath = (typeof __app_id !== 'undefined') ? `artifacts/${__app_id}/public/data/flower_exchanges` : "flower_exchanges";

        // STATE
        let db, auth, myId, partnerId, unsubscribeListener;
        let petals = 0, inventory = [], lastProcessedHeartbeat = 0, lastFlowerCount = 0;
        let isSignupMode = false;
        let audioCtx;
        let els = {}; 

        // DATA CONSTANTS
        const SHOP_ITEMS = [
            { id: 'bench', name: 'Bench', icon: 'ü™ë', price: 50 },
            { id: 'fountain', name: 'Fountain', icon: '‚õ≤', price: 100 },
            { id: 'tree', name: 'Tree', icon: 'üå≥', price: 75 },
            { id: 'cottage', name: 'Cottage', icon: 'üè†', price: 300 },
            { id: 'bird', name: 'Bird', icon: 'üê¶', price: 30 },
            { id: 'cat', name: 'Cat', icon: 'üêà', price: 60 },
            { id: 'lamp', name: 'Lamp', icon: 'üèÆ', price: 40 },
            { id: 'rainbow', name: 'Rainbow', icon: 'üåà', price: 150 }
        ];
        
        const DAILY_QUESTIONS = [
            "What was the highlight of your day?", "Favorite memory of us?", "One thing you're grateful for?",
            "Movie you want to watch?", "Dream vacation?", "Meal you'd love right now?",
            "Teleport anywhere, where?", "Something I do that makes you smile?", "Song on repeat?", "Us in one word."
        ];

        // --- INIT ---
        async function init() {
            // Populate DOM refs here to avoid race conditions
            els = {
                loading: document.getElementById('view-loading'),
                auth: document.getElementById('view-auth'),
                conn: document.getElementById('view-connection'),
                game: document.getElementById('view-game'),
                nav: document.getElementById('bottom-nav'),
                garden: document.getElementById('garden-container'),
                sky: document.getElementById('sky-layer'),
                bg: document.getElementById('bg-layer'),
                myId: document.getElementById('my-id'),
                partnerInput: document.getElementById('partner-id-input'),
                status: document.getElementById('status-display'),
                note: document.getElementById('love-note'),
                gift: document.getElementById('gift-overlay'),
                petals: document.getElementById('petals-count'),
                heartbeat: document.getElementById('heartbeat-overlay'),
                memoryWall: document.getElementById('memory-wall'),
                shopGrid: document.getElementById('shop-grid'),
                // Auth refs
                authTitle: document.getElementById('auth-title'),
                authBtn: document.getElementById('auth-action-btn'),
                authToggleBtn: document.getElementById('auth-toggle-btn'),
                authError: document.getElementById('auth-error'),
                // Daily refs
                dailyQ: document.getElementById('daily-question-text'),
                dailyInput: document.getElementById('daily-input-area'),
                dailyRes: document.getElementById('daily-result-area'),
                dailyStatus: document.getElementById('daily-status-msg'),
                partnerAnsDisplay: document.getElementById('partner-answer-display'),
                partnerAnsText: document.getElementById('partner-answer-text'),
                dailyInputText: document.getElementById('daily-answer-input')
            };

            try {
                // Restore theme
                const savedTheme = localStorage.getItem('love_garden_theme');
                if (savedTheme) {
                    window.changeTheme(savedTheme);
                    document.getElementById('theme-selector').value = savedTheme;
                } else {
                    const hour = new Date().getHours();
                    if (hour < 6 || hour > 19) window.changeTheme('theme-night');
                    else if (hour > 17) window.changeTheme('theme-sunset');
                }

                audioCtx = new (window.AudioContext || window.webkitAudioContext)();

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);
                db = getFirestore(app);

                onAuthStateChanged(auth, (user) => {
                    els.loading.classList.add('hidden');
                    if (user) {
                        myId = user.uid;
                        els.myId.textContent = myId;
                        els.auth.classList.add('hidden');
                        
                        const savedPartner = localStorage.getItem('flower_partner_id');
                        if (savedPartner) {
                            partnerId = savedPartner;
                            showGame();
                        } else {
                            els.conn.classList.remove('hidden');
                        }
                    } else {
                        els.auth.classList.remove('hidden');
                        els.conn.classList.add('hidden');
                        els.game.classList.add('hidden');
                        els.nav.classList.add('hidden');
                    }
                });
            } catch (e) { 
                console.error(e);
            }
        }

        function showGame() {
            els.conn.classList.add('hidden');
            els.game.classList.remove('hidden');
            els.nav.classList.remove('hidden');
            renderShop();
            setupListener();
        }

        // --- AUTH ---
        window.toggleAuthMode = () => {
            isSignupMode = !isSignupMode;
            els.authTitle.textContent = isSignupMode ? "Join" : "Welcome";
            els.authBtn.textContent = isSignupMode ? "Sign Up" : "Log In";
            els.authToggleBtn.textContent = isSignupMode ? "Log In" : "Create Account";
            els.authError.classList.add('hidden');
        };

        window.handleAuthAction = async () => {
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            try {
                if (isSignupMode) await createUserWithEmailAndPassword(auth, email, pass);
                else await signInWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                els.authError.textContent = e.message;
                els.authError.classList.remove('hidden');
            }
        };

        window.copyMyId = () => {
            navigator.clipboard.writeText(myId);
            alert("ID Copied!");
        };

        window.connectToPartner = () => {
            const pid = els.partnerInput.value.trim();
            if(!pid || pid === myId) return alert("Invalid ID");
            localStorage.setItem('flower_partner_id', pid);
            partnerId = pid;
            showGame();
        };

        // --- GAME LOGIC ---
        function setupListener() {
            if (unsubscribeListener) unsubscribeListener();
            const pairId = [myId, partnerId].sort().join('_');
            const docRef = doc(db, collectionPath, pairId);

            unsubscribeListener = onSnapshot(docRef, (snap) => {
                if (snap.exists()) {
                    const data = snap.data();
                    updateUI(data);
                } else {
                    els.status.textContent = "New garden created! Plant the first seed.";
                }
            });
        }

        function updateUI(data) {
            const count = data.count || 0;
            
            if (count > lastFlowerCount && lastFlowerCount !== 0 && data.sender !== myId) {
                els.gift.classList.remove('hidden');
                playSound('receive');
            }
            lastFlowerCount = count;

            const spent = data.spentPetals || 0;
            petals = count - spent;
            els.petals.textContent = petals;
            inventory = data.inventory || [];

            renderOrganicGarden(count);
            renderMemory(data.messageHistory || []);
            renderSky();

            if (data.lastHeartbeat && data.lastHeartbeat > lastProcessedHeartbeat) {
                if (data.heartbeatSender !== myId && (Date.now() - data.lastHeartbeat < 3000)) {
                    playSound('heartbeat');
                    els.heartbeat.classList.add('pulse-active');
                    setTimeout(() => els.heartbeat.classList.remove('pulse-active'), 2000);
                }
                lastProcessedHeartbeat = data.lastHeartbeat;
            }

            checkDaily(data);
        }

        // --- RENDERING ---
        function renderOrganicGarden(count) {
            els.garden.innerHTML = '<div class="ground-overlay"></div>';
            const visualCount = Math.min(count, 50);
            
            for(let i=0; i<visualCount; i++) {
                const el = document.createElement('div');
                el.className = 'flower-sprite';
                const left = ((i * 137.5) % 90) + 5; 
                const bottom = ((i * 50) % 40) + 25; 
                
                const scale = 0.8 + ((i % 5)/10);
                const flowers = ['üå∏', 'üåπ', 'üåª', 'üå∑', 'üå∫', 'üåº'];
                const emoji = flowers[i % flowers.length];
                
                el.style.left = `${left}%`;
                el.style.bottom = `${bottom}%`;
                el.style.transform = `scale(${scale})`;
                el.style.animationDelay = `${i * 0.05}s`;
                el.innerText = emoji;
                els.garden.appendChild(el);
            }
        }

        function renderMemory(history) {
            els.memoryWall.innerHTML = '';
            history.forEach(msg => {
                if (!msg.note) return;
                const div = document.createElement('div');
                div.className = 'polaroid';
                const date = new Date(msg.timestamp).toLocaleDateString();
                const sender = msg.sender === myId ? "Me" : "Partner";
                div.innerHTML = `
                    <div class="w-full h-24 bg-gray-100 mb-2 flex items-center justify-center text-4xl">${msg.flower}</div>
                    <div class="text-sm font-bold mb-1">"${msg.note}"</div>
                    <div class="text-xs text-gray-400 flex justify-between">
                        <span>${sender}</span>
                        <span>${date}</span>
                    </div>
                `;
                els.memoryWall.appendChild(div);
            });
        }

        function renderSky() {
            els.sky.innerHTML = '';
            SHOP_ITEMS.forEach(item => {
                if (inventory.includes(item.id)) {
                    const el = document.createElement('div');
                    el.className = 'text-4xl animate-pop';
                    el.innerText = item.icon;
                    els.sky.appendChild(el);
                }
            });
        }

        // --- ACTIONS ---
        window.sendFlower = async () => {
            if (!partnerId) return;
            const pairId = [myId, partnerId].sort().join('_');
            const note = els.note.value.trim();
            playSound('send');
            
            try {
                const docRef = doc(db, collectionPath, pairId);
                const snap = await getDoc(docRef);
                let currentHistory = snap.exists() ? (snap.data().messageHistory || []) : [];
                let count = snap.exists() ? (snap.data().count || 0) : 0;
                
                const flower = ['üå∏', 'üåπ', 'üåª'][Math.floor(Math.random()*3)];
                const msg = { sender: myId, note, flower, timestamp: Date.now() };
                currentHistory.unshift(msg);
                if(currentHistory.length > 20) currentHistory.pop();

                await setDoc(docRef, {
                    count: count + 1,
                    sender: myId,
                    note: note,
                    messageHistory: currentHistory,
                    timestamp: Date.now()
                }, { merge: true });
                
                els.note.value = '';
                els.status.textContent = "Flower planted!";
                startConfetti(); 
            } catch(e) { alert("Error sending"); }
        };

        window.sendHeartbeat = async () => {
            if(!partnerId) return;
            playSound('heartbeat');
            const pairId = [myId, partnerId].sort().join('_');
            await setDoc(doc(db, collectionPath, pairId), {
                lastHeartbeat: Date.now(),
                heartbeatSender: myId
            }, { merge: true });
        };

        window.openGift = () => {
            const gift = document.getElementById('gift-overlay');
            if(gift) gift.classList.add('hidden');
            try { playSound('levelup'); } catch(e){}
            startConfetti();
        };

        // --- SHOP & DAILY ---
        function renderShop() {
            els.shopGrid.innerHTML = '';
            SHOP_ITEMS.forEach(item => {
                const owned = inventory.includes(item.id);
                const div = document.createElement('div');
                div.className = `p-4 rounded-2xl bg-white/60 border border-white flex flex-col items-center shadow-sm ${owned ? 'opacity-50' : ''}`;
                div.innerHTML = `
                    <div class="text-4xl mb-2">${item.icon}</div>
                    <div class="font-bold text-sm">${item.name}</div>
                    <div class="text-xs text-pink-500 font-bold mb-2">${item.price} ü™ô</div>
                    ${!owned ? `<button onclick="buy('${item.id}', ${item.price})" class="px-4 py-1 bg-pink-500 text-white rounded-full text-xs font-bold juicy-btn">Buy</button>` : '<span class="text-xs text-green-600">Owned</span>'}
                `;
                els.shopGrid.appendChild(div);
            });
        }

        window.buy = async (id, price) => {
            if(petals < price) return alert("Not enough petals!");
            playSound('buy');
            const pairId = [myId, partnerId].sort().join('_');
            const docRef = doc(db, collectionPath, pairId);
            const snap = await getDoc(docRef);
            let spent = snap.data().spentPetals || 0;
            let inv = snap.data().inventory || [];
            await setDoc(docRef, { spentPetals: spent + price, inventory: [...inv, id] }, { merge: true });
        };

        function checkDaily(data) {
            const today = new Date().toDateString();
            const idx = Math.abs(today.split('').reduce((a,c)=>a+c.charCodeAt(0),0)) % DAILY_QUESTIONS.length;
            els.dailyQ.textContent = DAILY_QUESTIONS[idx];
            
            const dq = (data && data.dailyQ && data.dailyQ.date === today) ? data.dailyQ : null;
            if(dq && dq.answers && dq.answers[myId]) {
                els.dailyInput.classList.add('hidden');
                els.dailyRes.classList.remove('hidden');
                els.dailyStatus.textContent = "Answer submitted!";
                if(dq.answers[partnerId]) {
                    els.dailyStatus.textContent = "Partner answered! (+20 Bonus)";
                    els.partnerAnsDisplay.classList.remove('hidden');
                    els.partnerAnsText.textContent = dq.answers[partnerId];
                }
            } else {
                els.dailyInput.classList.remove('hidden');
                els.dailyRes.classList.add('hidden');
            }
        }

        window.submitDailyAnswer = async () => {
            const val = els.dailyInputText.value.trim();
            if(!val) return;
            const pairId = [myId, partnerId].sort().join('_');
            const today = new Date().toDateString();
            const docRef = doc(db, collectionPath, pairId);
            const snap = await getDoc(docRef);
            const data = snap.data();
            const dq = (data.dailyQ && data.dailyQ.date === today) ? data.dailyQ : { date: today, answers: {}, claimed: false };
            
            dq.answers = dq.answers || {};
            dq.answers[myId] = val;
            
            let bonus = 0;
            if(!dq.claimed && dq.answers[partnerId]) { bonus = 20; dq.claimed = true; playSound('levelup'); }
            
            await setDoc(docRef, { dailyQ: dq, count: (data.count||0) + bonus }, { merge: true });
        };

        // --- TABS & VISUALS ---
        window.switchTab = (tab) => {
            ['garden', 'memory', 'shop', 'daily'].forEach(t => {
                document.getElementById(`tab-${t}-content`).classList.add('hidden');
                document.getElementById(`nav-${t}`).classList.remove('active', 'text-pink-500');
                document.getElementById(`nav-${t}`).classList.add('text-gray-500');
            });
            document.getElementById(`tab-${tab}-content`).classList.remove('hidden');
            const btn = document.getElementById(`nav-${tab}`);
            btn.classList.add('active', 'text-pink-500');
            btn.classList.remove('text-gray-500');
        };

        window.changeTheme = (theme) => {
            document.body.className = `${theme} font-sans text-gray-800`;
            localStorage.setItem('love_garden_theme', theme);
            
            const bg = els.bg;
            bg.innerHTML = '';
            if(theme === 'theme-day') {
                for(let i=0; i<3; i++) {
                    const c = document.createElement('div');
                    c.className = 'cloud';
                    c.style.width = (100 + Math.random()*100) + 'px';
                    c.style.height = (40 + Math.random()*40) + 'px';
                    c.style.top = (Math.random()*30) + '%';
                    c.style.animationDuration = (20 + Math.random()*20) + 's';
                    bg.appendChild(c);
                }
            } else if (theme === 'theme-night') {
                for(let i=0; i<20; i++) {
                    const s = document.createElement('div');
                    s.className = 'star';
                    s.style.width = Math.random()*3 + 'px';
                    s.style.height = s.style.width;
                    s.style.top = Math.random()*50 + '%';
                    s.style.left = Math.random()*100 + '%';
                    s.style.animationDelay = Math.random()*2 + 's';
                    bg.appendChild(s);
                }
            }
        };

        // --- AUDIO HELPERS ---
        function playSound(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            let freq=440, dur=0.5;
            
            if (type === 'send') { freq=440; }
            else if (type === 'receive') { freq=554; }
            else if (type === 'heartbeat') { 
                freq=100; dur=0.2; osc.type='triangle'; 
            }
            else if (type === 'levelup') { freq=880; }
            else if (type === 'buy') { freq=600; dur=0.1; osc.type='square'; }

            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        // Confetti Helper
        function startConfetti() {
            const ctx = document.getElementById('confetti-canvas').getContext('2d');
            ctx.canvas.width = window.innerWidth; ctx.canvas.height = window.innerHeight;
            let p = [];
            for(let i=0; i<50; i++) p.push({x:Math.random()*ctx.canvas.width, y:Math.random()*ctx.canvas.height, vy:Math.random()*5+2, color:'hsl('+Math.random()*360+',100%,50%)'});
            function draw() {
                ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
                p.forEach((k,i)=>{ k.y+=k.vy; if(k.y>ctx.canvas.height) p.splice(i,1); ctx.fillStyle=k.color; ctx.fillRect(k.x,k.y,5,5); });
                if(p.length) requestAnimationFrame(draw);
            }
            draw();
        }

        // Init on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
